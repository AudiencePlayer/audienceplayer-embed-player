var e,t,r={d:(e,t)=>{for(var a in t)r.o(t,a)&&!r.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},a={};function n(e,t,r,a){return fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...a?{Authorization:"Bearer "+a}:{}},body:JSON.stringify({query:t,variables:r})}).then((e=>e.json()))}r.d(a,{Gf:()=>p,y5:()=>v,Pm:()=>d,L4:()=>_}),(t=e||(e={})).noPlayableAsset="noPlayableAsset",t.notAuthenticated="notAuthenticated",t.needEntitlement="needEntitlement",t.serverError="serverError",t.offlineError="offlineError",t.maxConcurrentStreamNumberError="maxConcurrentStreamNumberError";const s="application/x-mpegURL",i="video/mp4";function o(e){return{type:e.type,url:e.url,baseUrl:e.base_url,fileName:e.file_name}}function l(e){switch(e){case s:case"application/dash+xml":case i:return e;case"application/vnd.apple.mpegurl":return s;default:return console.warn(`Unknown mime-type ${e}, defaulting to mp4`),i}}class p{constructor(e,t){this.apiFetchUrl=`${e}/graphql/${t}/user`,this.token=null}setToken(e){this.token=e}getArticle(e){return n(this.apiFetchUrl,"\n    query Article($articleId: Int!) {\n        Article(id: $articleId) {\n            id\n            name\n            metas {\n                key\n                value\n            }\n            assets {\n                id\n                duration\n                linked_type\n                accessibility\n            }\n            posters {\n                type\n                url\n                title\n                base_url\n                file_name\n            }\n            images {\n                type\n                url\n                title\n                base_url\n                file_name\n            }\n        }\n    }\n",{articleId:e},this.token).then((e=>{if(!e||!e.data||e.errors){const{message:t,code:r}=e.errors[0];throw{message:t,code:r}}return{name:(t=e.data.Article).name,metas:(r=t.metas,r.reduce(((e,t)=>({...e,[t.key]:t.value})),{})),posters:t.posters.map(o),images:t.images.map(o)};var t,r}))}getArticleAssetPlayConfig(e,t=null,r=!0){return n(this.apiFetchUrl,"\n    mutation ArticleAssetPlay($articleId: Int, $assetId: Int, $protocols: [ArticlePlayProtocolEnum]) {\n        ArticleAssetPlay(article_id: $articleId, asset_id: $assetId, protocols: $protocols) {\n            article_id\n            asset_id\n            entitlements {\n                mime_type\n                protocol\n                manifest\n                is_live\n                token\n                encryption_type\n                key_delivery_url\n                encryption_provider\n                hls_key_uri\n                media_provider\n            }\n            subtitles {\n                url\n                locale\n                locale_label\n            }\n            pulse_token\n            appa\n            appr\n            fairplay_certificate_url\n            user_subtitle_locale\n            user_audio_locale\n            aspect_ratio\n            issued_at\n            time_marker_end\n            time_marker_intro_start\n            time_marker_intro_end\n        }\n    }\n",{articleId:e.articleId,assetId:e.assetId,protocols:["dash","hls"],device_model_context:t},this.token).then((t=>{if(!t||!t.data||t.errors){const{message:e,code:r}=t.errors[0];throw{message:e,code:r}}return console.log("response",t.data.ArticleAssetPlay),function(e,t,r=!0){const a=Date.parse(e.issued_at),n=[];(r&&e.entitlements.find((e=>"fps"===e.encryption_type))?e.entitlements.filter((e=>"aes"!==e.encryption_type)):e.entitlements).forEach((t=>{const a={src:t.manifest,type:l(t.mime_type),isLive:t.is_live,protectionInfo:null,mediaProvider:t.media_provider};if(t.encryption_type)if("cenc"===t.encryption_type&&0===t.protocol.indexOf("dash")){if(!r)return;a.protectionInfo=[{type:"Widevine",authenticationToken:"azl"===t.encryption_provider&&t.token?"Bearer "+t.token:"",keyDeliveryUrl:t.key_delivery_url,encryptionProvider:t.encryption_provider}]}else if("fps"===t.encryption_type&&0===t.protocol.indexOf("hls")){if(!r)return;a.protectionInfo=[{type:"FairPlay",authenticationToken:"azl"===t.encryption_provider&&t.token?"Bearer "+t.token:"",certificateUrl:e.fairplay_certificate_url,keyDeliveryUrl:t.key_delivery_url,encryptionProvider:t.encryption_provider,contentKeyId:"azl"===t.encryption_provider?t.key_delivery_url.replace("https://","skd://"):t.hls_key_uri}]}n.push(a)}));const s=e.subtitles.map((e=>({src:e.url,srclang:e.locale,kind:"subtitles",label:e.locale_label}))),i=t.continueFromPreviousPosition&&e.appa<e.time_marker_end?e.appa:0,o=e.time_marker_intro_end>0&&e.time_marker_intro_end>e.time_marker_intro_start?{skipIntro:{start:e.time_marker_intro_start,end:e.time_marker_intro_end}}:{};return{entitlements:n,subtitles:s,pulseToken:e.pulse_token,currentTime:i,continuePaused:t.continuePaused,articleId:e.article_id,assetId:e.asset_id,subtitleLocale:e.user_subtitle_locale,audioLocale:e.user_audio_locale,localTimeDelta:isNaN(a)?0:Date.now()-a,aspectRatio:e.aspect_ratio.replace("x",":"),...o}}(t.data.ArticleAssetPlay,e,r)}))}}var c,y,d,u,h,v;!function(e){e[e.loading=0]="loading",e[e.playing=1]="playing",e[e.paused=2]="paused",e[e.idle=3]="idle",e[e.buffering=4]="buffering",e[e.error=5]="error"}(c||(c={})),function(e){e.playStart="playStart",e.playing="playing",e.pause="pause",e.error="error",e.stopped="stopped",e.timeupdate="timeupdate",e.textTrackChanged="textTrackChanged",e.audioTrackChanged="audioTrackChanged"}(y||(y={})),function(e){e.chromecast="chromecast",e.default=""}(d||(d={})),function(e){e.play="play",e.playing="playing",e.paused="paused",e.stop="stop",e.error="error",e.configure="configure"}(u||(u={})),function(e){e.live="live",e.archive="archive",e.offline="offline"}(h||(h={}));class m{constructor(e,t){this.playLogs=[],this.apiCallInProgress=!1,this.intervalHandle=null,this.apiUrl=`${e}/service/${t}/analytics/stream/pulse/log`.replace(/\/*$/,"")}init(){null===this.intervalHandle&&(this.intervalHandle=setInterval((()=>{this.processFirstPlayLog()}),3e3))}destroy(){this.intervalHandle&&clearInterval(this.intervalHandle),this.intervalHandle=null}processPlaySession(e,t){if(!e)return;const r=e.eventStack;if(0===r.length)return;const a=[];let n=0,s=0,i=!1;for(;n<r.length;){const e=r[n];if(this.isEventTypeWithoutTimeDelta(e.eventType))a.push(this.convertEventToEventPayload(e)),i=!0;else if(i=!1,n-1>=0){const t=r[n-1];s+=e.timeStamp-t.timeStamp,e.state!==t.state&&(a.push(this.createDeltaEventPayload(t,t.timeStamp,s)),s=0)}n++}const o=r[r.length-1];if((s>0||!i)&&a.push(this.createDeltaEventPayload(o,t,s)),a.length>0){if(a.length>30){const e=a[a.length-1];a.splice(29),e.event_type=u.error,e.event_payload='{"code": 429, "message": "Too many events"}',a.push(e)}let t=this.getPlayerLogPayloadWithPulseToken(e.pulseToken);t||(t={event_stack:[],pulse_token:e.pulseToken,pulse_mode:e.isLive?h.live:h.offline,device_type:e.deviceType},this.playLogs.push(t)),a.forEach((e=>t.event_stack.push(e))),this.processPlayLog(t,e)}}processFirstPlayLog(){this.playLogs.length>0&&this.processPlayLog(this.playLogs[0],null)}processPlayLog(e,t){if(!e||this.apiCallInProgress)return;if(0===e.event_stack.length)return void this.removePlayLog(e);const r={...e,event_stack:[]};let a=0,n=!1;for(;a<e.event_stack.length&&r.event_stack.length<30&&!n;){const t=e.event_stack[a];a++,r.event_stack.push(t),t.event_type===u.stop&&(n=!0)}return r.pulse_mode===h.offline&&r.event_stack.length<30&&!n?void 0:(this.apiCallInProgress=!0,fetch(this.apiUrl,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(r)}).then((()=>!0)).catch((e=>0!==e.status)).then((t=>{t?(e.event_stack.splice(0,a),0===e.event_stack.length&&this.removePlayLog(e)):e.pulse_mode=h.archive,this.apiCallInProgress=!1})))}getPlayerLogPayloadWithPulseToken(e){return this.playLogs.find((t=>t.pulse_token===e))}removePlayLog(e){const t=this.playLogs.findIndex((t=>t.pulse_token===e.pulse_token));t>=0&&this.playLogs.splice(t,1)}isEventTypeWithoutTimeDelta(e){return[y.textTrackChanged,y.audioTrackChanged,y.playStart].indexOf(e)>=0}createBaseEventPayload(e,t){return{timestamp:e.timeStamp,event_type:t,appa:e.playPosition,appr:Math.min(e.playPosition/e.mediaDuration,1),resolution_tag:e.resolution}}convertEventToEventPayload(e){if(e.eventType===y.playStart)return{timestamp:e.timeStamp,event_type:u.play};const t=this.convertEventTypeToEventTypePayload(e),r=this.createBaseEventPayload(e,t);switch(e.eventType){case y.audioTrackChanged:return{...r,audio_locale:e.audioTrack};case y.textTrackChanged:return{...r,subtitle_locale:e.textTrack};default:return r}}createDeltaEventPayload(e,t,r){const a=this.getEventTypePayloadFromEventState(e);return{...this.createBaseEventPayload(e,a),...e.state===c.error?{event_payload:e.error}:{},timestamp:t,time_delta:r/1e3}}getEventTypePayloadFromEventState(e){switch(e.state){case c.playing:return u.playing;case c.paused:return u.paused;case c.error:return u.error;case c.buffering:case c.loading:return u.paused;case c.idle:return u.stop}}convertEventTypeToEventTypePayload(e){switch(e.eventType){case y.playStart:return u.play;case y.audioTrackChanged:case y.textTrackChanged:return u.configure;default:this.getEventTypePayloadFromEventState(e)}}}class _{constructor(e,t){this.intervalHandle=0,this.playerLogProcessor=new m(e,t),this.reset()}init(){this.playerLogProcessor.init()}destroy(){this.playerLogProcessor.destroy()}onStart(e,t,r,a,n){this.reset(),this.playSession={pulseToken:e,deviceType:t,eventStack:[],localTimeDelta:r,isLive:a,onStopCallback:n}}onCurrentTimeUpdated(e){this.playerProperties.playPosition=e,this.playerProperties.mediaDuration>0&&this.playerProperties.state!==c.idle&&this.logEvent(y.timeupdate)}onDurationUpdated(e){this.playerProperties.mediaDuration=e}onPlaying(){this.playerProperties.state!==c.playing&&(this.playerProperties.state===c.idle?(this.playerProperties.state=c.playing,this.logEvent(y.playStart),this.processPlaySession(),this.startInterval()):(this.playerProperties.state=c.playing,this.logEvent(y.playing)))}onPause(){this.playerProperties.state!==c.paused&&this.playerProperties.state!==c.idle&&(this.playerProperties.state=c.paused,this.logEvent(y.pause))}onError(e){this.playerProperties.state!==c.error&&(this.playerProperties.state=c.error,this.playerProperties.error=e,this.logEvent(y.error))}onStop(){this.playerProperties.state!==c.idle&&(this.playerProperties.state=c.idle,this.logEvent(y.stopped),this.stopInterval(),this.processPlaySession())}onTextTrackChanged(e){this.playerProperties.state!==c.idle&&(this.playerProperties.textTrack=e,this.logEvent(y.textTrackChanged))}onAudioTrackChanged(e){this.playerProperties.state!==c.idle&&(this.playerProperties.audioTrack=e,this.logEvent(y.audioTrackChanged))}updateProperties(e){this.playerProperties={...this.playerProperties,...e}}startInterval(){this.stopInterval(),this.intervalHandle=setInterval((()=>{this.processPlaySession()}),3e4)}stopInterval(){this.intervalHandle&&clearInterval(this.intervalHandle)}processPlaySession(){this.playerLogProcessor.processPlaySession({...this.playSession},this.getTimeStamp()),this.playSession.eventStack=[]}logEvent(e){this.playSession&&this.playSession.eventStack.push({...this.playerProperties,eventType:e,timeStamp:this.getTimeStamp()})}reset(){this.playSession=null,this.playerProperties={state:c.idle,error:null,mediaDuration:0,playPosition:0,audioTrack:null,textTrack:null,resolution:null}}getTimeStamp(){return Date.now()-(this.playSession?this.playSession.localTimeDelta:0)}}!function(e){e.chromecast_legacy="chromecast_legacy",e.chromecast_4k="chromecast_4k",e.lg_legacy="lg_legacy",e.lg_webos="lg_webos",e.samsung_tizen="samsung_tizen",e.tpvision_tva="tpvision_tva"}(v||(v={}));var g=a.Gf,P=a.y5,f=a.Pm,k=a.L4;export{g as ApiService,P as DeviceModelContextEnum,f as PlayerDeviceTypes,k as PlayerLoggerService};
//# sourceMappingURL=logging.js.map