var e,t,a={d:(e,t)=>{for(var r in t)a.o(t,r)&&!a.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},r={};function s(e,t,a,r){return fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...r?{Authorization:"Bearer "+r}:{}},body:JSON.stringify({query:t,variables:a})}).then((e=>e.json()))}a.d(r,{Gf:()=>p,y5:()=>v,Pm:()=>d,L4:()=>m}),(t=e||(e={})).noPlayableAsset="noPlayableAsset",t.notAuthenticated="notAuthenticated",t.needEntitlement="needEntitlement",t.serverError="serverError",t.offlineError="offlineError",t.maxConcurrentStreamNumberError="maxConcurrentStreamNumberError";const n="application/x-mpegURL",i="video/mp4";function o(e){return{type:e.type,url:e.url,baseUrl:e.base_url,fileName:e.file_name}}function l(e){switch(e){case n:case"application/dash+xml":case i:return e;case"application/vnd.apple.mpegurl":return n;default:return console.warn(`Unknown mime-type ${e}, defaulting to mp4`),i}}class p{constructor(e,t){this.apiFetchUrl=`${e}/graphql/${t}`,this.token=null}setToken(e){this.token=e}getArticle(e){return s(this.apiFetchUrl,"\n    query Article($articleId: Int!) {\n        Article(id: $articleId) {\n            id\n            name\n            metas {\n                key\n                value\n            }\n            assets {\n                id\n                duration\n                linked_type\n                accessibility\n            }\n            posters {\n                type\n                url\n                title\n                base_url\n                file_name\n            }\n            images {\n                type\n                url\n                title\n                base_url\n                file_name\n            }\n        }\n    }\n",{articleId:e},this.token).then((e=>{if(!e||!e.data||e.errors){const{message:t,code:a}=e.errors[0];throw{message:t,code:a}}return{name:(t=e.data.Article).name,metas:(a=t.metas,a.reduce(((e,t)=>({...e,[t.key]:t.value})),{})),posters:t.posters.map(o),images:t.images.map(o)};var t,a}))}getArticleAssetPlayConfig(e,t=null){return s(this.apiFetchUrl,"\n    mutation ArticleAssetPlay($articleId: Int, $assetId: Int, $protocols: [ArticlePlayProtocolEnum]) {\n        ArticleAssetPlay(article_id: $articleId, asset_id: $assetId, protocols: $protocols) {\n            article_id\n            asset_id\n            entitlements {\n                mime_type\n                protocol\n                manifest\n                is_live\n                token\n                encryption_type\n                key_delivery_url\n                encryption_provider\n                hls_key_uri\n                media_provider\n            }\n            subtitles {\n                url\n                locale\n                locale_label\n            }\n            pulse_token\n            appa\n            appr\n            fairplay_certificate_url\n            user_subtitle_locale\n            user_audio_locale\n            aspect_ratio\n            issued_at\n            time_marker_end\n        }\n    }\n",{articleId:e.articleId,assetId:e.assetId,protocols:["dash","hls"],device_model_context:t},this.token).then((t=>{if(!t||!t.data||t.errors){const{message:e,code:a}=t.errors[0];throw{message:e,code:a}}return function(e,t){const a=Date.parse(e.issued_at),r=[];(e.entitlements.find((e=>"fps"===e.encryption_type))?e.entitlements.filter((e=>"aes"!==e.encryption_type)):e.entitlements).forEach((t=>{const a={src:t.manifest,type:l(t.mime_type),isLive:t.is_live,protectionInfo:null,mediaProvider:t.media_provider};t.encryption_type&&("cenc"===t.encryption_type&&0===t.protocol.indexOf("dash")?a.protectionInfo=[{type:"Widevine",authenticationToken:"azl"===t.encryption_provider&&t.token?"Bearer "+t.token:"",keyDeliveryUrl:t.key_delivery_url,encryptionProvider:t.encryption_provider}]:"fps"===t.encryption_type&&0===t.protocol.indexOf("hls")&&(a.protectionInfo=[{type:"FairPlay",authenticationToken:"azl"===t.encryption_provider&&t.token?"Bearer "+t.token:"",certificateUrl:e.fairplay_certificate_url,keyDeliveryUrl:t.key_delivery_url,encryptionProvider:t.encryption_provider,contentKeyId:"azl"===t.encryption_provider?t.key_delivery_url.replace("https://","skd://"):t.hls_key_uri}])),r.push(a)}));const s=e.subtitles.map((e=>({src:e.url,srclang:e.locale,kind:"subtitles",label:e.locale_label}))),n=t&&e.appa<e.time_marker_end?e.appa:0;return{entitlements:r,subtitles:s,pulseToken:e.pulse_token,currentTime:n,articleId:e.article_id,assetId:e.asset_id,subtitleLocale:e.user_subtitle_locale,audioLocale:e.user_audio_locale,localTimeDelta:isNaN(a)?0:Date.now()-a,aspectRatio:e.aspect_ratio.replace("x",":")}}(t.data.ArticleAssetPlay,e.continueFromPreviousPosition)}))}}var c,y,d,u,h,v;!function(e){e[e.loading=0]="loading",e[e.playing=1]="playing",e[e.paused=2]="paused",e[e.idle=3]="idle",e[e.buffering=4]="buffering",e[e.error=5]="error"}(c||(c={})),function(e){e.playStart="playStart",e.playing="playing",e.pause="pause",e.error="error",e.stopped="stopped",e.timeupdate="timeupdate",e.textTrackChanged="textTrackChanged",e.audioTrackChanged="audioTrackChanged"}(y||(y={})),function(e){e.chromecast="chromecast",e.default=""}(d||(d={})),function(e){e.play="play",e.playing="playing",e.paused="paused",e.stop="stop",e.error="error",e.configure="configure"}(u||(u={})),function(e){e.live="live",e.archive="archive",e.offline="offline"}(h||(h={}));class g{constructor(e,t){this.playLogs=[],this.apiCallInProgress=!1,this.intervalHandle=null,this.apiUrl=`${e}/service/${t}/analytics/stream/pulse/log`.replace(/\/*$/,"")}init(){null===this.intervalHandle&&(this.intervalHandle=setInterval((()=>{this.processFirstPlayLog()}),3e3))}destroy(){this.intervalHandle&&clearInterval(this.intervalHandle),this.intervalHandle=null}processPlaySession(e,t){if(!e)return;const a=e.eventStack;if(0===a.length)return;const r=[];let s=0,n=0,i=!1;for(;s<a.length;){const e=a[s];if(this.isEventTypeWithoutTimeDelta(e.eventType))r.push(this.convertEventToEventPayload(e)),i=!0;else if(i=!1,s-1>=0){const t=a[s-1];n+=e.timeStamp-t.timeStamp,e.state!==t.state&&(r.push(this.createDeltaEventPayload(t,t.timeStamp,n)),n=0)}s++}const o=a[a.length-1];if((n>0||!i)&&r.push(this.createDeltaEventPayload(o,t,n)),r.length>0){if(r.length>30){const e=r[r.length-1];r.splice(29),e.event_type=u.error,e.event_payload='{"code": 429, "message": "Too many events"}',r.push(e)}let t=this.getPlayerLogPayloadWithPulseToken(e.pulseToken);t||(t={event_stack:[],pulse_token:e.pulseToken,pulse_mode:e.isLive?h.live:h.offline,device_type:e.deviceType},this.playLogs.push(t)),r.forEach((e=>t.event_stack.push(e))),this.processPlayLog(t,e)}}processFirstPlayLog(){this.playLogs.length>0&&this.processPlayLog(this.playLogs[0],null)}processPlayLog(e,t){if(!e||this.apiCallInProgress)return;if(0===e.event_stack.length)return void this.removePlayLog(e);const a={...e,event_stack:[]};let r=0,s=!1;for(;r<e.event_stack.length&&a.event_stack.length<30&&!s;){const t=e.event_stack[r];r++,a.event_stack.push(t),t.event_type===u.stop&&(s=!0)}return a.pulse_mode===h.offline&&a.event_stack.length<30&&!s?void 0:(this.apiCallInProgress=!0,fetch(this.apiUrl,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(a)}).then((()=>!0)).catch((e=>0!==e.status)).then((t=>{t?(e.event_stack.splice(0,r),0===e.event_stack.length&&this.removePlayLog(e)):e.pulse_mode=h.archive,this.apiCallInProgress=!1})))}getPlayerLogPayloadWithPulseToken(e){return this.playLogs.find((t=>t.pulse_token===e))}removePlayLog(e){const t=this.playLogs.findIndex((t=>t.pulse_token===e.pulse_token));t>=0&&this.playLogs.splice(t,1)}isEventTypeWithoutTimeDelta(e){return[y.textTrackChanged,y.audioTrackChanged,y.playStart].indexOf(e)>=0}createBaseEventPayload(e,t){return{timestamp:e.timeStamp,event_type:t,appa:e.playPosition,appr:Math.min(e.playPosition/e.mediaDuration,1),resolution_tag:e.resolution}}convertEventToEventPayload(e){if(e.eventType===y.playStart)return{timestamp:e.timeStamp,event_type:u.play};const t=this.convertEventTypeToEventTypePayload(e),a=this.createBaseEventPayload(e,t);switch(e.eventType){case y.audioTrackChanged:return{...a,audio_locale:e.audioTrack};case y.textTrackChanged:return{...a,subtitle_locale:e.textTrack};default:return a}}createDeltaEventPayload(e,t,a){const r=this.getEventTypePayloadFromEventState(e);return{...this.createBaseEventPayload(e,r),...e.state===c.error?{event_payload:e.error}:{},timestamp:t,time_delta:a/1e3}}getEventTypePayloadFromEventState(e){switch(e.state){case c.playing:return u.playing;case c.paused:return u.paused;case c.error:return u.error;case c.buffering:case c.loading:return u.paused;case c.idle:return u.stop}}convertEventTypeToEventTypePayload(e){switch(e.eventType){case y.playStart:return u.play;case y.audioTrackChanged:case y.textTrackChanged:return u.configure;default:this.getEventTypePayloadFromEventState(e)}}}class m{constructor(e,t){this.intervalHandle=0,this.playerLogProcessor=new g(e,t),this.reset()}init(){this.playerLogProcessor.init()}destroy(){this.playerLogProcessor.destroy()}onStart(e,t,a,r,s){this.reset(),this.playSession={pulseToken:e,deviceType:t,eventStack:[],localTimeDelta:a,isLive:r,onStopCallback:s}}onCurrentTimeUpdated(e){this.playerProperties.playPosition=e,this.playerProperties.mediaDuration>0&&this.playerProperties.state!==c.idle&&this.logEvent(y.timeupdate)}onDurationUpdated(e){this.playerProperties.mediaDuration=e}onPlaying(){this.playerProperties.state!==c.playing&&(this.playerProperties.state===c.idle?(this.playerProperties.state=c.playing,this.logEvent(y.playStart),this.processPlaySession(),this.startInterval()):(this.playerProperties.state=c.playing,this.logEvent(y.playing)))}onPause(){this.playerProperties.state!==c.paused&&this.playerProperties.state!==c.idle&&(this.playerProperties.state=c.paused,this.logEvent(y.pause))}onError(e){this.playerProperties.state!==c.error&&(this.playerProperties.state=c.error,this.playerProperties.error=e,this.logEvent(y.error))}onStop(){this.playerProperties.state!==c.idle&&(this.playerProperties.state=c.idle,this.logEvent(y.stopped),this.stopInterval(),this.processPlaySession())}onTextTrackChanged(e){this.playerProperties.state!==c.idle&&(this.playerProperties.textTrack=e,this.logEvent(y.textTrackChanged))}onAudioTrackChanged(e){this.playerProperties.state!==c.idle&&(this.playerProperties.audioTrack=e,this.logEvent(y.audioTrackChanged))}updateProperties(e){this.playerProperties={...this.playerProperties,...e}}startInterval(){this.stopInterval(),this.intervalHandle=setInterval((()=>{this.processPlaySession()}),3e4)}stopInterval(){this.intervalHandle&&clearInterval(this.intervalHandle)}processPlaySession(){this.playerLogProcessor.processPlaySession({...this.playSession},this.getTimeStamp()),this.playSession.eventStack=[]}logEvent(e){this.playSession&&this.playSession.eventStack.push({...this.playerProperties,eventType:e,timeStamp:this.getTimeStamp()})}reset(){this.playSession=null,this.playerProperties={state:c.idle,error:null,mediaDuration:0,playPosition:0,audioTrack:null,textTrack:null,resolution:null}}getTimeStamp(){return Date.now()-(this.playSession?this.playSession.localTimeDelta:0)}}!function(e){e.chromecast_legacy="chromecast_legacy",e.chromecast_4k="chromecast_4k",e.lg_legacy="lg_legacy",e.lg_webos="lg_webos",e.samsung_tizen="samsung_tizen",e.tpvision_tva="tpvision_tva"}(v||(v={}));var _=r.Gf,P=r.y5,f=r.Pm,k=r.L4;export{_ as ApiService,P as DeviceModelContextEnum,f as PlayerDeviceTypes,k as PlayerLoggerService};
//# sourceMappingURL=logging.js.map