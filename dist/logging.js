var e,t,a,s,r,i={d:(e,t)=>{for(var a in t)i.o(t,a)&&!i.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},o={};i.d(o,{P:()=>a,L:()=>l}),function(e){e[e.loading=0]="loading",e[e.playing=1]="playing",e[e.paused=2]="paused",e[e.idle=3]="idle",e[e.buffering=4]="buffering",e[e.error=5]="error"}(e||(e={})),function(e){e.playStart="playStart",e.playing="playing",e.pause="pause",e.error="error",e.stopped="stopped",e.timeupdate="timeupdate",e.textTrackChanged="textTrackChanged",e.audioTrackChanged="audioTrackChanged"}(t||(t={})),function(e){e.chromecast="chromecast",e.default=""}(a||(a={})),function(e){e.play="play",e.playing="playing",e.paused="paused",e.stop="stop",e.error="error",e.configure="configure"}(s||(s={})),function(e){e.live="live",e.archive="archive",e.offline="offline"}(r||(r={}));class n{constructor(e,t){this.playLogs=[],this.apiCallInProgress=!1,this.intervalHandle=null,this.apiUrl=`${e}/service/${t}/analytics/stream/pulse/log`.replace(/\/*$/,"")}init(){null===this.intervalHandle&&(this.intervalHandle=setInterval((()=>{this.processFirstPlayLog()}),3e3))}destroy(){this.intervalHandle&&clearInterval(this.intervalHandle),this.intervalHandle=null}processPlaySession(e,t){if(!e)return;const a=e.eventStack;if(0===a.length)return;const i=[];let o=0,n=0,l=!1;for(;o<a.length;){const e=a[o];if(this.isEventTypeWithoutTimeDelta(e.eventType))i.push(this.convertEventToEventPayload(e)),l=!0;else if(l=!1,o-1>=0){const t=a[o-1];n+=e.timeStamp-t.timeStamp,e.state!==t.state&&(i.push(this.createDeltaEventPayload(t,t.timeStamp,n)),n=0)}o++}const p=a[a.length-1];if((n>0||!l)&&i.push(this.createDeltaEventPayload(p,t,n)),i.length>0){if(i.length>30){const e=i[i.length-1];i.splice(29),e.event_type=s.error,e.event_payload='{"code": 429, "message": "Too many events"}',i.push(e)}let t=this.getPlayerLogPayloadWithPulseToken(e.pulseToken);t||(t={event_stack:[],pulse_token:e.pulseToken,pulse_mode:e.isLive?r.live:r.offline,device_type:e.deviceType},this.playLogs.push(t)),i.forEach((e=>t.event_stack.push(e))),this.processPlayLog(t,e)}}processFirstPlayLog(){this.playLogs.length>0&&this.processPlayLog(this.playLogs[0],null)}processPlayLog(e,t){if(!e||this.apiCallInProgress)return;if(0===e.event_stack.length)return void this.removePlayLog(e);const a={...e,event_stack:[]};let i=0,o=!1;for(;i<e.event_stack.length&&a.event_stack.length<30&&!o;){const t=e.event_stack[i];i++,a.event_stack.push(t),t.event_type===s.stop&&(o=!0)}return a.pulse_mode===r.offline&&a.event_stack.length<30&&!o?void 0:(this.apiCallInProgress=!0,fetch(this.apiUrl,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(a)}).then((()=>!0)).catch((e=>0!==e.status)).then((t=>{t?(e.event_stack.splice(0,i),0===e.event_stack.length&&this.removePlayLog(e)):e.pulse_mode=r.archive,this.apiCallInProgress=!1})))}getPlayerLogPayloadWithPulseToken(e){return this.playLogs.find((t=>t.pulse_token===e))}removePlayLog(e){const t=this.playLogs.findIndex((t=>t.pulse_token===e.pulse_token));t>=0&&this.playLogs.splice(t,1)}isEventTypeWithoutTimeDelta(e){return[t.textTrackChanged,t.audioTrackChanged,t.playStart].indexOf(e)>=0}createBaseEventPayload(e,t){return{timestamp:e.timeStamp,event_type:t,appa:e.playPosition,appr:Math.min(e.playPosition/e.mediaDuration,1),resolution_tag:e.resolution}}convertEventToEventPayload(e){if(e.eventType===t.playStart)return{timestamp:e.timeStamp,event_type:s.play};const a=this.convertEventTypeToEventTypePayload(e),r=this.createBaseEventPayload(e,a);switch(e.eventType){case t.audioTrackChanged:return{...r,audio_locale:e.audioTrack};case t.textTrackChanged:return{...r,subtitle_locale:e.textTrack};default:return r}}createDeltaEventPayload(t,a,s){const r=this.getEventTypePayloadFromEventState(t);return{...this.createBaseEventPayload(t,r),...t.state===e.error?{event_payload:t.error}:{},timestamp:a,time_delta:s/1e3}}getEventTypePayloadFromEventState(t){switch(t.state){case e.playing:return s.playing;case e.paused:return s.paused;case e.error:return s.error;case e.buffering:case e.loading:return s.paused;case e.idle:return s.stop}}convertEventTypeToEventTypePayload(e){switch(e.eventType){case t.playStart:return s.play;case t.audioTrackChanged:case t.textTrackChanged:return s.configure;default:this.getEventTypePayloadFromEventState(e)}}}class l{constructor(e,t){this.intervalHandle=0,this.playerLogProcessor=new n(e,t),this.reset()}init(){this.playerLogProcessor.init()}destroy(){this.playerLogProcessor.destroy()}onStart(e,t,a,s,r){this.reset(),this.playSession={pulseToken:e,deviceType:t,eventStack:[],localTimeDelta:a,isLive:s,onStopCallback:r}}onCurrentTimeUpdated(a){this.playerProperties.playPosition=a,this.playerProperties.mediaDuration>0&&this.playerProperties.state!==e.idle&&this.logEvent(t.timeupdate)}onDurationUpdated(e){this.playerProperties.mediaDuration=e}onPlaying(){this.playerProperties.state!==e.playing&&(this.playerProperties.state===e.idle?(this.playerProperties.state=e.playing,this.logEvent(t.playStart),this.processPlaySession(),this.startInterval()):(this.playerProperties.state=e.playing,this.logEvent(t.playing)))}onPause(){this.playerProperties.state!==e.paused&&this.playerProperties.state!==e.idle&&(this.playerProperties.state=e.paused,this.logEvent(t.pause))}onError(a){this.playerProperties.state!==e.error&&(this.playerProperties.state=e.error,this.playerProperties.error=a,this.logEvent(t.error))}onStop(){this.playerProperties.state!==e.idle&&(this.playerProperties.state=e.idle,this.logEvent(t.stopped),this.stopInterval(),this.processPlaySession())}onTextTrackChanged(a){this.playerProperties.state!==e.idle&&(this.playerProperties.textTrack=a,this.logEvent(t.textTrackChanged))}onAudioTrackChanged(a){this.playerProperties.state!==e.idle&&(this.playerProperties.audioTrack=a,this.logEvent(t.audioTrackChanged))}updateProperties(e){this.playerProperties={...this.playerProperties,...e}}startInterval(){this.stopInterval(),this.intervalHandle=setInterval((()=>{this.processPlaySession()}),3e4)}stopInterval(){this.intervalHandle&&clearInterval(this.intervalHandle)}processPlaySession(){this.playerLogProcessor.processPlaySession({...this.playSession},this.getTimeStamp()),this.playSession.eventStack=[]}logEvent(e){this.playSession&&this.playSession.eventStack.push({...this.playerProperties,eventType:e,timeStamp:this.getTimeStamp()})}reset(){this.playSession=null,this.playerProperties={state:e.idle,error:null,mediaDuration:0,playPosition:0,audioTrack:null,textTrack:null,resolution:null}}getTimeStamp(){return Date.now()-(this.playSession?this.playSession.localTimeDelta:0)}}var p=o.P,h=o.L;export{p as PlayerDeviceTypes,h as PlayerLoggerService};
//# sourceMappingURL=logging.js.map